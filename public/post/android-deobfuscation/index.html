<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Stacktrace deobfuscation</title>

    
    <link rel="shortcut icon" type="image/png" href="http://andriydruk.com//favicon.png"/>

    
    <link href="http://andriydruk.com//css/bootstrap.min.css" rel="stylesheet">

    
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Condensed&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

    
    <script src="https://use.fontawesome.com/b50aa728ce.js"></script>
    <style>
      i {
        margin: 7px;
      }
      a.uncolored {
        color: inherit;
        font-weight: inherit;
      }
      a {
        font-weight: bold;
      }
    </style>

    
    <link rel="stylesheet" href="http://andriydruk.com/css/idea.css">
    <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>
<br>
<br>


    
    <header class="intro-header">
     <div class="container">
       <div class="row">
         <a href="http://andriydruk.com/"><img src="http://andriydruk.com//img/logo.jpg" class="img-circle center-block" width="120" height="120"></a>
       </div>
       <div class="row">
         <div class="col-lg-6 col-lg-offset-3 col-md-10 col-md-offset-1">
             <h1 class="text-uppercase text-center">Stacktrace Deobfuscation</h1>
             
                  <h4 class="text-center">
                    <small>
                      Published Tue, Aug 4, 2015 <strong>by <a href="mailto:andriy.druk@gmail.com?Subject=Stacktrace%20Deobfuscation" class="uncolored">Andriy Druk</a></strong>
                    </small>
                  </h4>
            
            <hr class="small">
         </div>
       </div>
     </div>
    </header>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-1">
                  <p>One of the problems of supporting Android application is deobfuscation or retrace stack traces obtained from obfuscated release build. To figure out how to deobfuscate a stack trace, you need to understand how actually the obfuscation works. The standard way of obfuscation in Android development is using tools such as the ProGuard. That&rsquo;s what the <a href="http://developer.android.com/tools/help/proguard.html#decoding">official documentation</a> says</p>

<blockquote>
<p>The ProGuard tool shrinks, optimizesstatic innerand obfuscates your code by removing unused code and renaming classes, fields, and methods with semantically obscure names.</p>
</blockquote>

<p>Well, looks good. Let&rsquo;s try to practice. I will create a new project by using Android Studio and add next options to <code>build.gradle</code> file to obfuscate <code>debug</code> builds:</p>

<pre><code class="language-gradle">buildTypes {
    debug {
        minifyEnabled true
        proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
    }
    release {
        minifyEnabled false
        proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
    }
}
</code></pre>

<p>Let&rsquo;s throw <code>Exception</code> in <code>onCreate</code> method of <code>MainActivity</code> class:</p>

<pre><code class="language-java">@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    throw new RuntimeException(&quot;Stack deobfuscation example exception&quot;);
}
</code></pre>

<p>After running you will get something like:</p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
    at com.druk.myapplication.MainActivity.onCreate(Unknown Source)
    at android.app.Activity.performCreate(Activity.java:6162)
    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
    at android.app.ActivityThread.-wrap11(ActivityThread.java)
    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:148)
    at android.app.ActivityThread.main(ActivityThread.java:5415)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>Why after obfuscation the <code>MainActivity</code> is still the <code>MainActivity</code>? The fact is that in addition to the configuration file <code>proguard-rules.pro</code> in our catalog, ProGuard uses default rules of Android projects obfuscation from the SDK, which weaken obfuscation of <code>Activity's</code> inheritors. The documentation contains following guidelines for Android projects:</p>

<pre><code class="language-java">-keep public class * extends android.app.Activity
-keep public class * extends android.app.Application
-keep public class * extends android.app.Service
-keep public class * extends android.content.BroadcastReceiver
-keep public class * extends android.content.ContentProvider
</code></pre>

<p>By default ProGuard will keep names of all inheritance of <code>android.app.Activity</code>. Ok, I created an inner static class to avoid this rule.</p>

<pre><code class="language-java">private static class CrashHelper{

    public static void crash(){
        throw new RuntimeException(&quot;Stack deobfuscation example exception&quot;);
    }
}
</code></pre>

<p>Now when I call method crash from <code>onCreate</code> I got:</p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
     at com.druk.myapplication.a.b(Unknown Source)
     at com.druk.myapplication.a.a(Unknown Source)
     at com.druk.myapplication.MainActivity.onCreate(Unknown Source)
     at android.app.Activity.performCreate(Activity.java:6162)
     at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
     at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
     at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
     at android.app.ActivityThread.-wrap11(ActivityThread.java)
     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
     at android.os.Handler.dispatchMessage(Handler.java:102)
     at android.os.Looper.loop(Looper.java:148)
     at android.app.ActivityThread.main(ActivityThread.java:5415)
     at java.lang.reflect.Method.invoke(Native Method)
     at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>It&rsquo;s exactly what we are looking for: the exception was thrown in method <code>b</code> of class <code>a</code> that was called from method &lsquo;a&rsquo;.</p>

<p>For deobfuscation we needed file <code>mapping.txt</code> from <code>build</code>. In my case path ro the file was <code>app/build/outputs/mapping/debug/mapping.txt</code>. Next you need to run script retrace.sh from <code>ANDROID_HOME/tools/proguard/bin</code> or run GUI utilits called ProguadGUI from <code>ANDROID_HOME/tools/proguard/lib/proguardgui.jar</code>. I used GUI utils and got next:</p>

<p><img src="http://andriydruk.com/img/Screen Shot 2015-08-04 at 23.34.25.png" alt="Alt text" /></p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
    at com.druk.myapplication.MainActivity$CrashHelper.crash(Unknown Source)
    at com.druk.myapplication.MainActivity$CrashHelper.access$000(Unknown Source)
    at com.druk.myapplication.MainActivity.onCreate(Unknown Source)
    at android.app.Activity.performCreate(Activity.java:6162)
    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
    at android.app.ActivityThread.-wrap11(ActivityThread.java)
    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:148)
    at android.app.ActivityThread.main(ActivityThread.java:5415)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>One more thing, we need numbers of line in a file where the crash occurred instead of current <code>Unknown Source</code>. According to <a href="http://proguard.sourceforge.net/manual/examples.html#stacktrace">official docs</a> for that you should add next lines to ProGuard properties:</p>

<pre><code class="language-java">-printmapping out.map
-keepattributes SourceFile,LineNumberTable
-renamesourcefileattribute SourceFile
</code></pre>

<p>The first rule is already in Android project by default, will skip it. The second rule will switch on saving of source filename and table of line numbers. But the most interesting is the third one that will rename all filename to <code>Source file</code>. It&rsquo;s critical for languages like Java where filenames are usually the same to class name. Also, it will hide relations between inner and outer classes.</p>

<p>After updating proguard file I got:</p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
    at com.druk.myapplication.a.b(SourceFile:42)
    at com.druk.myapplication.a.a(SourceFile:40)
    at com.druk.myapplication.MainActivity.onCreate(SourceFile:15)
    at android.app.Activity.performCreate(Activity.java:6162)
    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
    at android.app.ActivityThread.-wrap11(ActivityThread.java)
    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:148)
    at android.app.ActivityThread.main(ActivityThread.java:5415)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>And after deobfuscation:</p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
    at com.druk.myapplication.MainActivity$CrashHelper.crash(SourceFile:42)
    at com.druk.myapplication.MainActivity$CrashHelper.access$000(SourceFile:40)
    at com.druk.myapplication.MainActivity.onCreate(SourceFile:15)
    at android.app.Activity.performCreate(Activity.java:6162)
    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
    at android.app.ActivityThread.-wrap11(ActivityThread.java)
    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:148)
    at android.app.ActivityThread.main(ActivityThread.java:5415)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>To summarize, I can strongly recommend you to keep all mapping file for your release builds to be able to deobfuscate stack traces from crash logs. Best practice is building releases on your CI server with saving apk and mapping file with tags of releases. At this case, you will always know where you can find mapping file for you release build. Also, there are a lot of services that provide automatic deobfuscation of stack traces such as Fabric or Google Play Developer Console. But keep in mind that you provide your mapping file to 3-rd party service, and they can deobfuscate your builds and get all source code.</p>

                  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'yetanotherandroiddeveloperblog';
    var disqus_identifier = 'http:\/\/andriydruk.com\/post\/android-deobfuscation\/';
    var disqus_title = 'Stacktrace deobfuscation';
    var disqus_url = 'http:\/\/andriydruk.com\/post\/android-deobfuscation\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
            </div>
        </div>
    </article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-6 col-lg-offset-3 col-md-10 col-md-offset-1">
              <hr>
              <h4 class="text-center">
                <small>
                  <strong>©2016 <a href="mailto:andriy.druk@gmail.com" class="uncolored">Andriy Druk</a></strong>
                  <br> Build with <a href="https://gohugo.io" class="uncolored">Hugo</a> on <a href="https://pages.github.com" class="uncolored">GitHub pages</a>
                </small>
              </h4>
            </div>
        </div>
    </div>
</footer>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-67278568-1', 'auto');
  ga('send', 'pageview');
</script>


</body>
</html>

