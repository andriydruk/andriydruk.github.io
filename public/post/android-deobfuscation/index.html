<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <title>Деобфускация трассировок стека - Yet Another Android Developer Blog</title>
    <meta name="generator" content="Hugo 0.15" />

    
    <link rel="canonical" href="http://andriydruk.github.io/post/android-deobfuscation/">
    

    <meta property="og:url" content="http://andriydruk.github.io/post/android-deobfuscation/">
    <meta property="og:title" content="Yet Another Android Developer Blog">
    <meta property="og:image" content="http://andriydruk.github.io/img/logo.png">
    <meta name="apple-mobile-web-app-title" content="Yet Another Android Developer Blog">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="http://andriydruk.github.io/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="http://andriydruk.github.io/images/favicon.ico">
    
    <style>
      @font-face {
        font-family: 'Icon';
        src: url('http://andriydruk.github.io/fonts/icon.eot?52m981');
        src: url('http://andriydruk.github.io/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
             url('http://andriydruk.github.io/fonts/icon.woff?52m981')
               format('woff'),
             url('http://andriydruk.github.io/fonts/icon.ttf?52m981')
               format('truetype'),
             url('http://andriydruk.github.io/fonts/icon.svg?52m981#icon')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="http://andriydruk.github.io/stylesheets/application.css">
    <link rel="stylesheet" href="http://andriydruk.github.io/stylesheets/palettes.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,700|Roboto%2bMono">
    <style>
      body, input {
        font-family: 'Roboto', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Roboto Mono', Menlo, 'Courier New', 'Courier', monospace;
      }
    </style>
    
    
    <script src="http://andriydruk.github.io/javascripts/modernizr.js"></script>

    
    <link rel="stylesheet" href="http://andriydruk.github.io/stylesheets/idea.css">
    <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

  </head>
  <body class=" ">


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Деобфускация трассировок стека
      </div>
    </div>
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="http://andriydruk.github.io/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="http://andriydruk.github.io/img/logo.png">
        </div>
      
      <div class="name">
        <strong>Andriy Druk</strong>
          <br>
          Software Mobile Engineer
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
        <ul class="repo">
          <li class="repo-download">
            <a href="https://twitter.com/AndriyDruk" title="@AndriyDruk on Twitter" target="_blank">
              <i style="ignore" class="icon icon-twitter"></i> Twitter
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/andriydruk" title="@andriydruk on GitHub" target="_blank">
              <i style="ignore" class="icon icon-github"></i> Github
            </a>
          </li>
        </ul>
        <hr>

      <div class="toc">
        <ul>
          <li>
            <span class="section">Articles</span>
            <ul>
                
                <li class="anchor">
                  <a title="R.Tools" href="http://andriydruk.github.io/post/rtools/">R.Tools</a>
                </li>  
                
                <li class="anchor">
                  <a title="Wrap Annoying APIs With RxJava" href="http://andriydruk.github.io/post/rxdnssd/">Wrap Annoying APIs With RxJava</a>
                </li>  
                
                <li class="anchor">
                  <a title="Bonjour In Android Applications" href="http://andriydruk.github.io/post/mdnsresponder/">Bonjour In Android Applications</a>
                </li>  
                
                <li class="anchor">
                  <a title="Деобфускация Трассировок Стека" href="http://andriydruk.github.io/post/android-deobfuscation/">Деобфускация Трассировок Стека</a>
                </li>  
                
                <li class="anchor">
                  <a title="Что Такое .Aar Библиотеки?" href="http://andriydruk.github.io/post/what_is_aars/">Что Такое .Aar Библиотеки?</a>
                </li>  
                
                <li class="anchor">
                  <a title="Добро Пожаловать" href="http://andriydruk.github.io/post/welcome/">Добро Пожаловать</a>
                </li>  
                
            </ul> 
          </li>
        </ul>

        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>
				Деобфускация трассировок стека 
				<a class="headerlink" href="#" title="Permanent link">Tue, Aug 4, 2015</a>
			</h1>

			<p>Одной из самых плохо описанных областей в Android разработке есть руководства по использованию инструментов разработчика. Поэтому я решил описать их в серии небольших статей. В этой статья я хочу рассказать о том какие инструменты предоставляет SDK для работы с трассировками стеков (stacktraces), полученых из выпущенных сборок.</p>

<p>Одной из проблем поддержки выпущенных Android приложений является деобфускация или retrace трассировок стеков полученнных из обфусцированных сборок. Для того чтобы разобраться в том как деобфусцировать трассировки стеков, нужно понять как работает обфускация. Стандратным способом обфускации в Android есть использования такого инструмента как ProGuard. Вот что о нем говорит <a href="http://developer.android.com/tools/help/proguard.html#decoding">официальная документация</a></p>

<blockquote>
<p>The ProGuard tool shrinks, optimizes, and obfuscates your code by removing unused code and renaming classes, fields, and methods with semantically obscure names.</p>
</blockquote>

<p>Ну чтож звучит неплохо, попробуем на практике. Начнем с самого простого: создадим новый проект с помощью Android Studio и включим обфускацию для отладочных сборок:</p>

<pre><code class="language-gradle">buildTypes {
    debug {
        minifyEnabled true
        proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
    }
    release {
        minifyEnabled false
        proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
    }
}
</code></pre>

<p>Выкинем новое исключение в методе onCreate класса MainActivity</p>

<pre><code class="language-java">@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    throw new RuntimeException(&quot;Stack deobfuscation example exception&quot;);
}
</code></pre>

<p>После запуска получим трассировку стека похожую на следующую</p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
    at com.druk.myapplication.MainActivity.onCreate(Unknown Source)
    at android.app.Activity.performCreate(Activity.java:6162)
    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
    at android.app.ActivityThread.-wrap11(ActivityThread.java)
    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:148)
    at android.app.ActivityThread.main(ActivityThread.java:5415)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>Почему же после обфускации MainActivity осталась MainActivity? Дело в том что помимо конфигурационого файла proguard-rules.pro в нашем каталоге (который в сгенерированном примере долежен быть пустым), ProGuard использует стандратные правила обфускации Android проектов из SDK, которые и ослабляют обфускацию наследников Activity. В документации Proguard можно найти следующие правила для Android проектов:</p>

<pre><code class="language-java">-keep public class * extends android.app.Activity
-keep public class * extends android.app.Application
-keep public class * extends android.app.Service
-keep public class * extends android.content.BroadcastReceiver
-keep public class * extends android.content.ContentProvider
</code></pre>

<p>Тоесть по умолчанию ProGuard оставляет все имена классов, которые являются наследниками android.app.Activity. Продолжим наш эксперемент: создадим внутренни статический класс, который поможет нам вызвать аварийную ситуацию в нашем приложении</p>

<pre><code class="language-java">private static class CrashHelper{

    public static void crash(){
        throw new RuntimeException(&quot;Stack deobfuscation example exception&quot;);
    }
}
</code></pre>

<p>Вызвав статический метод crash в onCreate мы получим следующую трассировку стека:</p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
     at com.druk.myapplication.a.b(Unknown Source)
     at com.druk.myapplication.a.a(Unknown Source)
     at com.druk.myapplication.MainActivity.onCreate(Unknown Source)
     at android.app.Activity.performCreate(Activity.java:6162)
     at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
     at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
     at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
     at android.app.ActivityThread.-wrap11(ActivityThread.java)
     at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
     at android.os.Handler.dispatchMessage(Handler.java:102)
     at android.os.Looper.loop(Looper.java:148)
     at android.app.ActivityThread.main(ActivityThread.java:5415)
     at java.lang.reflect.Method.invoke(Native Method)
     at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
     at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>Похоже это то что мы хотели получить. У некоторого мифического класса &lsquo;а&rsquo; был вызван метод &lsquo;a&rsquo;, в теле которого был вызван метод &lsquo;b&rsquo;.</p>

<p>Для деобфускации нам нужен файл mapping.txt из нашего build каталога. В моем случае путь к файлу app/build/outputs/mapping/debug/mapping.txt. Далее необходимо воспользоваться либо скриптом retrace.sh из ANDROID_HOME/tools/proguard/bin, либо воспользоваться GUI утилитой ProguadGUI из ANDROID_HOME/tools/proguard/lib/proguardgui.jar. Воспользовавшись GUI утилитой мы получим следующую трассировку стека:</p>

<p><img src="http://andriydruk.github.io/img/Screen Shot 2015-08-04 at 23.34.25.png" alt="Alt text" /></p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
    at com.druk.myapplication.MainActivity$CrashHelper.crash(Unknown Source)
    at com.druk.myapplication.MainActivity$CrashHelper.access$000(Unknown Source)
    at com.druk.myapplication.MainActivity.onCreate(Unknown Source)
    at android.app.Activity.performCreate(Activity.java:6162)
    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
    at android.app.ActivityThread.-wrap11(ActivityThread.java)
    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:148)
    at android.app.ActivityThread.main(ActivityThread.java:5415)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>Хорошо когда в методе у нас всего одна строка, но на практике такое встречается редко. Поэтому неплохо было бы получить номер строки вместо Unknown Source. Согласно <a href="http://proguard.sourceforge.net/manual/examples.html#stacktrace">официальной документации</a> для этого нужно в файл настроек proguard добавить</p>

<pre><code class="language-java">-printmapping out.map
-renamesourcefileattribute SourceFile
-keepattributes SourceFile,LineNumberTable
</code></pre>

<p>Первая строка в нашем случае не нужна, потому что она включена в Android проектах по умолчанию. Третья строка включает сохранение имен исходных файлов и таблицы номеров строк (что мы и хотели получить). Но стоит обратить внимание на вторую строку. Это правило переименовывает все имена исходных файлов в  &ldquo;SourceFile&rdquo;, что является весьма важным в обфускации таких языков как Java, где зачастую Class name == Source file name. Также это возволяет не выдать внутрених классов, так как после обфускации связь между внутреним и внешним классами обычно разрывается.</p>

<p>В итоге после добавления новых правил мы получим следующую трассировку стека:</p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
    at com.druk.myapplication.a.b(SourceFile:42)
    at com.druk.myapplication.a.a(SourceFile:40)
    at com.druk.myapplication.MainActivity.onCreate(SourceFile:15)
    at android.app.Activity.performCreate(Activity.java:6162)
    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
    at android.app.ActivityThread.-wrap11(ActivityThread.java)
    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:148)
    at android.app.ActivityThread.main(ActivityThread.java:5415)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>И после деобфускации:</p>

<pre><code class="language-java">Caused by: java.lang.RuntimeException: Stack deobfuscation example exception
    at com.druk.myapplication.MainActivity$CrashHelper.crash(SourceFile:42)
    at com.druk.myapplication.MainActivity$CrashHelper.access$000(SourceFile:40)
    at com.druk.myapplication.MainActivity.onCreate(SourceFile:15)
    at android.app.Activity.performCreate(Activity.java:6162)
    at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1107)
    at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2370)
    at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2477)
    at android.app.ActivityThread.-wrap11(ActivityThread.java)
    at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1345)
    at android.os.Handler.dispatchMessage(Handler.java:102)
    at android.os.Looper.loop(Looper.java:148)
    at android.app.ActivityThread.main(ActivityThread.java:5415)
    at java.lang.reflect.Method.invoke(Native Method)
    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:725)
    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:615)
</code></pre>

<p>Подведем итог: залог успешной поддержки обфусцированного приложения это сохранения всех mapping файлов для всех выпущенных сборок. Хорошой практикой есть построение сборок на CI сервере с сохрарнением apk файлов и mapping файлов с тегами соотвествующих сборок (например 4 первых символа hash коммита). В таком случае если вы знаете с какой сборки былa получена трассировка стека, вы будете знать где искать соответсующий mapping файл. Также возможно стоит посмотреть в сторону сторонних сервисов сбора информации о аварийных ситуациях. Например, такие сервисы как Crashlytics деобфусцируют трасировки стеков на стороне сервера, что весьма удобно и не требует никаких дополнительных действий со стороны разработчика. Но вы должны четко понимать что при каждом построении сборки ваши mapping файлы будут отправляться на сервера Crashlytics. Что может быть не безопасно, ведь человек завладевший этими файлами не будет имееть никаких ограничений по деобфускации всего исходного кода вашего приложения.</p>

			<h1></h1>
			<br>
			<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'yetanotherandroiddeveloperblog';
    var disqus_identifier = 'http:\/\/andriydruk.github.io\/post\/android-deobfuscation\/';
    var disqus_title = 'Деобфускация трассировок стека';
    var disqus_url = 'http:\/\/andriydruk.github.io\/post\/android-deobfuscation\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="http://andriydruk.github.io/post/what_is_aars/" title="Что такое .aar библиотеки?">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Что такое .aar библиотеки?
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="http://andriydruk.github.io/post/mdnsresponder/" title="Bonjour in Android applications">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Bonjour in Android applications
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>




			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
      var base_url = 'http:\/\/andriydruk.github.io\/';
      var repo_id  = '